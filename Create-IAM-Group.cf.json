{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudFormation for creating IAM groups and Policies",
  "Metadata": {},
  "Parameters": {
    "ApplicationCode": {
      "Type": "String",
      "Default": "nvta"
    },
    "StageName": {
      "Type": "String",
      "Default": "dev"
    }
  },
  "Mappings": {},
  "Conditions": {},
  "Resources": {
    "DeveloperGroup": {
      "Type": "AWS::IAM::Group",
      "Properties": {
        "GroupName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "ApplicationCode"
              },
              "-developers"
            ]
          ]
        },
        "Path": {
          "Fn::Join": [
            "",
            [
              "/",
              {
                "Ref": "ApplicationCode"
              },
              "/"
            ]
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AWSCodeCommitFullAccess",
          "arn:aws:iam::aws:policy/AdministratorAccess",
          "arn:aws:iam::aws:policy/job-function/NetworkAdministrator",
          "arn:aws:iam::aws:policy/PowerUserAccess"
        ],
        "Policies": [
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  "policy-",
                  {
                    "Ref": "ApplicationCode"
                  },
                  "-limited-iam"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "iam:CreateUser",
                    "iam:DeleteUser",
                    "iam:UpdateUser",
                    "iam:AttachUserPolicy",
                    "iam:DeleteUserPolicy",
                    "iam:DetachUserPolicy",
                    "iam:PutUserPolicy"
                  ],
                  "Resource": "*",
                  "Effect": "Deny",
                  "Sid": "DenyUserManagement"
                },
                {
                  "Action": [
                    "iam:AddUserToGroup",
                    "iam:RemoveUserFromGroup"
                  ],
                  "Resource": "*",
                  "Effect": "Deny",
                  "Sid": "LimitGroupMemberShipManagement"
                },
                {
                  "Action": [
                    "iam:CreateGroup",
                    "iam:DeleteGroup",
                    "iam:UpdateGroup",
                    "iam:AttachGroupPolicy",
                    "iam:DetachGroupPolicy",
                    "iam:DeleteGroupPolicy",
                    "iam:PutGroupPolicy"
                  ],
                  "Resource": "*",
                  "Effect": "Deny",
                  "Sid": "DenyGroupManagement"
                },
                {
                  "Action": [
                    "iam:PutRolePermissionsBoundary",
                    "iam:PutUserPermissionsBoundary",
                    "iam:DeleteUserPermissionsBoundary",
                    "iam:DeleteRolePermissionsBoundary"
                  ],
                  "Resource": "*",
                  "Effect": "Deny",
                  "Sid": "DenyBoundariesManagement"
                },
                {
                  "Action": [
                    "iam:*"
                  ],
                  "Resource": [
                    "arn:aws:iam::*:role/core/*",
                    "arn:aws:iam::*:user/core/*",
                    "arn:aws:iam::*:group/core/*"
                  ],
                  "Effect": "Deny",
                  "Sid": "DenyCoreResourcesManagement"
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  "policy-",
                  {
                    "Ref": "ApplicationCode"
                  },
                  "-assume-roles"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "sts:AssumeRole"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:iam::*:role/",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "/role-",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "-read-only"
                        ]
                      ]
                    }
                  ],
                  "Effect": "Allow"
                },
                {
                  "Action": [
                    "sts:AssumeRole"
                  ],
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:iam::*:role/",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "/role-",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "-read-only"
                        ]
                      ]
                    }
                  ],
                  "Effect": "Allow"
                },
                {
                  "Action": [
                    "sts:AssumeRole"
                  ],
                  "Effect": "Deny",
                  "NotResource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:iam::*:role/",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "/role-",
                          {
                            "Ref": "ApplicationCode"
                          },
                          "-read-only"
                        ]
                      ]
                    }
                  ]
                }
              ]
            }
          },
          {
            "PolicyName": {
              "Fn::Join": [
                "",
                [
                  "policy-",
                  {
                    "Ref": "ApplicationCode"
                  },
                  "-list-secrets"
                ]
              ]
            },
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "VisualEditor0",
                  "Effect": "Allow",
                  "Action": [
                    "secretsmanager:DescribeSecret",
                    "secretsmanager:ListSecrets",
                    "secretsmanager:ListSecretVersionIds"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs": {}
}